<!DOCTYPE html>
<!--
   //////////////////////////////////////////////////////////////////////////
   //                                                                      //
   //    This file is automatically generated by the publish.py script.    //
   //    Any changes made manually will be overwritten during the next     //
   //    publish action.                                                   //
   //                                                                      //
   //////////////////////////////////////////////////////////////////////////
-->
<head>
   <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
   <meta http-equiv="Pragma" content="no-cache">
   <meta http-equiv="Expires" content="-1">
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>MusicBrainz Picard Documentation</title>
</head>
<body>
   <div id='redirection_error'></div>
   <script>
      var target_language = '{{default_language}}';
      var target_version = '';
      var stable_version = '{{stable_version}}';
      var supported_languages = {{supported_languages}};
      var version_list = {{version_list}};
      var src_host = window.location.hostname;
      var src_protocol = window.location.protocol;
      var src_path = window.location.pathname;
      var src_path_parts = src_path.split('/');
      var target_path = '';
      var target_url = '';
      var well_formed = true;

      var debug = false;

      const re_language = /^[a-z][a-z](-[A-Z][A-Z])?$/;
      const re_version1 = /^v?[0-9][0-9\.]*$/;
      const re_version2 = /^v[0-9][0-9\.]*$/;
      const re_version3 = /^v([0-9]+\.[0-9]+)/;
      const re_version4 = /^v?([0-9]+\.[0-9]+)/;

      const not_found = 'not_found.html';

      function is_language(test_language) {
         if (debug) { window.alert("Testing language: " + test_language); }
         if (test_language.search(re_language) < 0) {
            if (debug) { window.alert("Failed regular expression check."); }
            return false;
         }
         if (supported_languages.indexOf(test_language) < 0) {
            if (debug) { window.alert("Failed supported languages check.  Target language set to: " + target_language); }
            // Returning true will drop this item from the path
            return true;
         }
         target_language = test_language;
         if (debug) { window.alert("Passed.  Target language set to: " + target_language); }
         return true;
      }

      function is_rtd_version(test_version) {
         if (debug) { window.alert("Testing RTD version: " + test_version); }
         if (test_version.search(re_version1) < 0) {
            if (debug) { window.alert("Failed regular expression check."); }
            return false;
         }
         var arr = re_version4.exec(test_version);
         var temp = arr[1];
         if (version_list.indexOf(temp) < 0) {
            if (debug) { window.alert("Failed supported versions check.  Version: " + temp); }
            // Returning true will drop this item from the path
            return true;
         }
         target_version = '/v' + temp;
         if (debug) { window.alert("Passed. Target version set to: " + target_version); }
         return true;
      }

      function is_gh_version(test_version) {
         if (debug) { window.alert("Testing GH version: " + test_version); }
         if (test_version.search(re_version2) < 0) {
            if (debug) { window.alert("Failed regular expression check."); }
            return false;
         }
         var arr = re_version3.exec(test_version);
         var temp = arr[1];
         if (version_list.indexOf(temp) < 0) {
            if (debug) { window.alert("Failed supported versions check.  Version: " + temp); }
            target_version = '';
            return true;
         }
         target_version = '/v' + temp;
         if (target_version != '/' + test_version) {
            if (debug) { window.alert("Target Version " + target_version + " != Test Version /" + test_version); }
            if (debug) { window.alert("Changing well_formed to false."); }
            well_formed = false;
         }
         if (debug) { window.alert("Passed. Target version set to: " + target_version); }
         return true;
      }

      var counter = 1;
      if (src_path_parts[src_path_parts.length - 1] == not_found) {
         if (debug) { window.alert("Unable to find the not_found.html file."); }
         document.getElementById('redirection_error').innerHTML = "<h1>Redirection Error</h1>\n<p>We're sorry but there was a problem redirecting to your requested page.</p>";
      }
      else {
         // Check for GitHub Pages style version number
         if (is_gh_version(src_path_parts[counter])) {
            counter += 1;
         }

         // Check for language identifier
         if (is_language(src_path_parts[counter])) {
            counter += 1;
         }

         var anchor_test = document.URL.split('#');
         if (debug) { window.alert('Performing anchor test.\n\nLength: ' + anchor_test.length + "\nLast Part: " + anchor_test[anchor_test.length - 1]); }
         if ((anchor_test.length > 1) && (anchor_test[anchor_test.length - 1] == "redirected")) {
            target_url = src_protocol + '//' + src_host + target_version + '/' + target_language + '/' + not_found;
            if (debug) { window.alert('Page has already been redirected.\n\nOld URL: ' + window.location + "\nNew URL: " + target_url); }
         }
         else {
            // Check for ReadTheDocs style version number
            if (src_path_parts[counter] == 'latest') {
               well_formed = false;
               target_version = '';
               counter += 1;
            }
            else {
               if (src_path_parts[counter] == 'stable') {
                  well_formed = false;
                  target_version = '/v' + stable_version;
                  counter += 1;
               }
               else {
                  if (is_rtd_version(src_path_parts[counter])) {
                     well_formed = false;
                     counter += 1;
                  }
               }
            }

            // Check for language identifier
            if (is_language(src_path_parts[counter])) {
               counter += 1;
               well_formed = false;
            }

            // Patch to redirect to new location of scripting documentation
            if (src_path_parts[counter] == 'scripting.html') {
               target_path += '/extending';
               if (debug) { window.alert("Patching target url for updated location of scripting.html file."); }
               well_formed = false;
            }

            // Combine remaining portions of the submitted path
            while (counter < src_path_parts.length) {
               target_path += '/' + src_path_parts[counter];
               counter += 1;
            }

            // Build the redirection target url
            target_url = src_protocol + '//' + src_host + target_version + '/' + target_language;
            if ((well_formed) || (target_url + target_path == window.location)) {
               if (debug) {
                  if (well_formed) {
                     window.alert("well_formed is true.");
                  }
                  if (target_url + target_path == window.location) {
                     window.alert("Target path same as the source path.");
                  }
               }
               target_url += '/' + not_found;
            }
            else {
               target_url += target_path + "#redirected";
            }
            if (debug) { window.alert('Old URL: ' + window.location + "\nNew URL: " + target_url); }
         }

         // Redirect to the new target
         window.location.href = target_url
      }
   </script>
</body>
</html>
